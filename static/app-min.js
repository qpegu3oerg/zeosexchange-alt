window.marketBuy=Module.cwrap("marketBuy","string",["string","string","string","string","string","string","number","number","number"]),window.marketSell=Module.cwrap("marketSell","string",["string","string","string","string","string","string","number","number","number"]),window.determineBuyAmount=Module.cwrap("determineBuyAmount","string",["string","string","string","string","string","string","number","number","number"]),window.determineSellAmount=Module.cwrap("determineSellAmount","string",["string","string","string","string","string","string","number","number","number"]),window.encryptBytes=Module.cwrap("encryptBytes","string",["string","string"]),window.decryptBytes=Module.cwrap("decryptBytes","string",["string","string"]),window.encryptOrder=Module.cwrap("encryptOrder","string",["string","string","string","string","string","string","string","string"]),window.decryptOrder=Module.cwrap("decryptOrder","string",["string","string"]);const chainId="73e4385a2708e6d7048834fbc1079f2fabb17b3c125b146af438971e90716c4d",nodeUrl="https://jungle4.cryptolions.io",identifier="zeosexchange",transport=new AnchorLinkBrowserTransport,link=new AnchorLink({transport,chains:[{chainId,nodeUrl}]});var session=null,stop_permission=null,ref_bn=0,ref_ts=0,mid=0;const markets=new Map;var symbols=[],limit_orders=[],stop_orders=[];const user_balances=[0,0,0],last_bar=new Map,last_block=new Map,tv_subs=new Map;function base_precision(t){return parseInt(t.market.base_symbol.substring(0,t.market.base_symbol.indexOf(",")))}function quote_precision(t){return parseInt(t.market.quote_symbol.substring(0,t.market.quote_symbol.indexOf(",")))}function base_symbolcode(t){return t.market.base_symbol.substring(t.market.base_symbol.indexOf(",")+1)}function quote_symbolcode(t){return t.market.quote_symbol.substring(t.market.quote_symbol.indexOf(",")+1)}function login(){null===session&&$("#login").modal("show")}function restoreSession(){link.restoreSession(identifier).then(t=>{(session=t)&&didLogin()})}function anchorLogin(){link.login(identifier).then(t=>{session=t.session,didLogin()})}function logout(){$("#login-switch").attr("src","login-icon-hover.png"),$("#login-switch").attr("onmouseover","this.src='login-icon-hover.png'"),$("#login-switch").attr("onmouseout","this.src='login-icon.png'"),$("#login-switch").attr("title","connect wallet"),$("#login-switch").attr("onclick","login()"),session.remove(),session=null,setTimeout(async()=>{await fetchMarket(mid),updateUI(),fetchBalances(),resetBuyInput(),resetSellInput(),resetDepositInput(),resetWithdrawInput()},1e3)}async function didLogin(){$("#login-switch").attr("src","logout-icon.png"),$("#login-switch").attr("onmouseover","this.src='logout-icon-hover.png'"),$("#login-switch").attr("onmouseout","this.src='logout-icon.png'"),$("#login-switch").attr("title","logout "+session.auth.actor),$("#login-switch").attr("onclick","logout()"),$("#ti-buy-ot").val("limit").trigger("change"),$("#ti-sell-ot").val("limit").trigger("change"),$(".session-actor").html(String(session.auth.actor));"822af2811ab6c050357fc924dc3ebc3b253a7f845ad80e574282d40b77afce92"===await fetchCodeHash(String(session.auth.actor))&&($("#unlock-stopcontract").modal("show"),$("#stop-password").focus(),$("#stop-password").off("keydown").on("keydown",t=>{"Enter"===t.key&&unlockStopContract()})),setTimeout(async()=>{await fetchMarket(mid),updateUI(),fetchBalances()},1e3)}function toggleTheme(){$("body").toggleClass("dark-theme"),$("body").hasClass("dark-theme")?(localStorage.setItem("dark-theme",!0),window.tvWidget.changeTheme("dark"),$("#toggle-theme-switch").attr("src","sun-icon.png"),$("#toggle-theme-switch").attr("onmouseover","this.src='sun-icon-hover.png'"),$("#toggle-theme-switch").attr("onmouseout","this.src='sun-icon.png'"),$("#toggle-theme-switch").attr("title","switch to light theme")):(localStorage.setItem("dark-theme",null),window.tvWidget.changeTheme("light"),$("#toggle-theme-switch").attr("src","moon-icon.png"),$("#toggle-theme-switch").attr("onmouseover","this.src='moon-icon-hover.png'"),$("#toggle-theme-switch").attr("onmouseout","this.src='moon-icon.png'"),$("#toggle-theme-switch").attr("title","switch to dark theme"))}async function fetchMarket(t){let e;await $.post("/market",{id:t},(t,i,a)=>{e=t},"json");var i={amount_base:1,amount_quote:1,amount_shares:1,amount_base:1,amount_open:1,amount_dealt:1,price:1,v:1,p:1},a=JSON.parse(JSON.stringify(e),function(t,e){return i.hasOwnProperty(t)?parseInt(e,10):e});if(tv_subs.forEach((t,e)=>{if(t.symbolInfo.full_name===symbols[a.id].full_name){let i=t.resolution;if("1D"===i)i=864e5;else if("1W"===i)i=6048e5;else{if("1M"===i)return;i*=6e4}if(t.lastBar.time+2*i<bn2ts(a.market.history[a.market.history.length-1].b)||Date.now()>=t.lastBar.time+2*i)t.reset(),window.tvWidget.chart().resetData();else{let o=0;for(;o<a.market.history.length&&a.market.history[o].b<=t.lastBlock;)o++;for(;o<a.market.history.length;){if(bn2ts(a.market.history[o].b)>=t.lastBar.time+i){let s={time:t.lastBar.time+i,open:t.lastBar.close,high:t.lastBar.close,low:t.lastBar.close,close:a.market.history[o].p/Math.pow(10,a.market.price_decimals),volume:a.market.history[o].v/Math.pow(10,base_precision(a))};t.lastBar=s}else a.market.history[o].p/Math.pow(10,a.market.price_decimals)<t.lastBar.low?t.lastBar.low=a.market.history[o].p/Math.pow(10,a.market.price_decimals):a.market.history[o].p/Math.pow(10,a.market.price_decimals)>t.lastBar.high&&(t.lastBar.high=a.market.history[o].p/Math.pow(10,a.market.price_decimals)),t.lastBar.volume+=a.market.history[o].v/Math.pow(10,base_precision(a)),t.lastBar.close=a.market.history[o].p/Math.pow(10,a.market.price_decimals);t.lastBlock=a.market.history[o].b,t.update(t.lastBar),o++}if(o==a.market.history.length&&Date.now()>=t.lastBar.time+i){let r={time:t.lastBar.time+i,open:t.lastBar.close,high:t.lastBar.close,low:t.lastBar.close,close:t.lastBar.close,volume:0};t.update(r),t.lastBar=r}}}}),markets.has(t)){let o=markets.get(t).market.history.filter(t=>!a.market.history.find(e=>t.b===e.b&&t.v===e.v&&t.p===e.p&&t.t===e.t));a.market.history=[...o,...a.market.history]}markets.set(t,a)}async function fetchAllSymbols(){await $.post("/symbols",{},(t,e,i)=>{symbols=t},"json")}async function fetchReferenceBlockTime(){await $.post("/refblocktime",{},(t,e,i)=>{ref_bn=t.ref_bn,ref_ts=t.ref_ts},"json")}async function fetchAccount(t){let e="";return await $.post("/account",{account_name:t},(t,i,a)=>{e=t.account},"json"),e}async function fetchCodeHash(t){let e="";return await $.post("/codehash",{account_name:t},(t,i,a)=>{e=t.codehash},"json"),e}async function fetchPermission(t){let e="";return await $.post("/permission",{account_name:t},(t,i,a)=>{e=t.key_ct},"json"),e}async function fetchStopOrders(){if(null===session||null===stop_permission)return;let t=[];await $.post("/stoporders",{account_name:String(session.auth.actor)},(e,i,a)=>{t=e.orders,stop_orders=[]},"json"),t.forEach(t=>{let e=window.decryptBytes(t.aes_key_ct,stop_permission.pw),i=JSON.parse(window.decryptOrder(t.order_ct,e));stop_orders.push({id:t.id,market_id:i.market_id,amount:i.amount,code:i.code,stop_price:i.stop_price,limit_price:i.limit_price,timestamp:i.timestamp,aes_key:e})})}async function fetchTickerList(){await $.post("/ticker",{},(t,e,i)=>{$("#ticker-list > tbody").empty();let a=0;t.forEach(t=>{$("#ticker-list > tbody").append("<tr onclick='window.tvWidget.setSymbol(\""+symbols[a].full_name+'", "1D", ()=>{});\'><td>'+t.symbol+"</td><td class='price "+("+"==t.h24_change.charAt(0)?"buy":"-"==t.h24_change.charAt(0)?"sell":"")+"'>"+t.last_price+" "+t.symbol.substring(t.symbol.indexOf("/")+1)+"</td><td class='price "+("+"==t.h24_change.charAt(0)?"buy":"-"==t.h24_change.charAt(0)?"sell":"")+"'>"+t.h24_change+"</td></tr>"),a++})},"json")}async function fetchBalances(){let t=markets.get(mid);if(null===session)user_balances[0]=0,user_balances[1]=0,user_balances[2]=0;else{let e=String(session.auth.actor);await $.post("/balance",{code:t.market.base_symbol_contract,account:e,symbol:base_symbolcode(t)},(t,e,i)=>{0===t.length?user_balances[0]=0:user_balances[0]=parseFloat(t[0].substring(0,t[0].indexOf(" ")))},"json"),await $.post("/balance",{code:t.market.quote_symbol_contract,account:e,symbol:quote_symbolcode(t)},(t,e,i)=>{0===t.length?user_balances[1]=0:user_balances[1]=parseFloat(t[0].substring(0,t[0].indexOf(" ")))},"json"),await $.post("/balance",{code:"zeosexchange",account:e,symbol:market2symbol(t.id)},(t,e,i)=>{0===t.length?user_balances[2]=0:user_balances[2]=parseInt(t[0].substring(0,t[0].indexOf(" ")))},"json")}$("#bbal").html(user_balances[0]+" "+base_symbolcode(t)),$("#qbal").html(user_balances[1]+" "+quote_symbolcode(t)),$("#sbal").html(user_balances[2]+" "+market2symbol(t.id)),$(".poolpercentage-user").html((user_balances[2]/t.market.amount_shares*100).toFixed(4)),$(".poolamountbase-user").html((user_balances[2]/t.market.amount_shares*t.market.amount_base/Math.pow(10,base_precision(t))).toFixed(base_precision(t))),$(".poolamountquote-user").html((user_balances[2]/t.market.amount_shares*t.market.amount_quote/Math.pow(10,quote_precision(t))).toFixed(quote_precision(t)))}function buf2hex(t){return[...new Uint8Array(t)].map(t=>t.toString(16).padStart(2,"0")).join("")}function hex2buf(t){let e=[];for(let i=0;i<t.length;i+=2)e.push(parseInt(t.substr(i,2),16));return e}async function setupStopContract(){let t=[],e=await fetchAccount(String(session.auth.actor));-1!==e.ram_quota&&e.ram_quota-e.ram_usage<27e4&&t.push({account:"eosio",name:"buyrambytes",authorization:[{actor:session.auth.actor,permission:"active"},],data:{bytes:27e4-(e.ram_quota-e.ram_usage),payer:session.auth.actor,receiver:session.auth.actor}});"822af2811ab6c050357fc924dc3ebc3b253a7f845ad80e574282d40b77afce92"!==await fetchCodeHash(String(session.auth.actor))&&t.push(...[{account:"eosio",name:"setcode",authorization:[{actor:session.auth.actor,permission:"active"},],data:{account:session.auth.actor,vmtype:0,vmversion:0,code:await (await fetch("stopcontract.wasm.hex")).text()}},{account:"eosio",name:"setabi",authorization:[{actor:session.auth.actor,permission:"active"},],data:{account:session.auth.actor,abi:await (await fetch("stopcontract.abi.hex")).text()}}]);let i=!1,a=!1,o;e.permissions.forEach(t=>{"active"===t.perm_name&&(t.required_auth.accounts.forEach(t=>{"eosio.code"===t.permission.permission&&(i=!0)}),o=t.required_auth),"zeosexecstop"===t.perm_name&&(a=!0)}),i||(o.accounts.push({permission:{actor:session.auth.actor,permission:"eosio.code"},weight:1}),t.push({account:"eosio",name:"updateauth",authorization:[{actor:session.auth.actor,permission:"active"}],data:{account:session.auth.actor,permission:"active",parent:"owner",auth:o}}));let s=await eosjs_ecc.randomKey(),r=eosjs_ecc.privateToPublic(s);t.push({account:"eosio",name:"updateauth",authorization:[{actor:session.auth.actor,permission:"active"}],data:{account:session.auth.actor,permission:"zeosexecstop",parent:"active",auth:{threshold:1,accounts:[],keys:[{key:r,weight:1}],waits:[]}}}),a||t.push({account:"eosio",name:"linkauth",authorization:[{actor:session.auth.actor,permission:"active"}],data:{account:session.auth.actor,code:session.auth.actor,type:"executeorder",requirement:"zeosexecstop"}});let l=new TextEncoder().encode($("#set-stop-password").val()),n=buf2hex(await crypto.subtle.digest("SHA-256",l)).substring(0,32),c=window.encryptBytes(buf2hex(eosjs_ecc.PrivateKey.fromString(s).toBuffer()),n);link.transact({actions:t},{broadcast:!0}).then(t=>{alert("Success! Execute the second transaction in order to save your new 'zeosexecstop' permission's private key in your account.");let e={account:session.auth.actor,name:"setpermkey",authorization:[{actor:session.auth.actor,permission:"active"}],data:{key_ct:c}};link.transact({action:e},{broadcast:!0}).then(t=>{stop_permission={pw:n,key:s.toString()},$("#ti-buy-ot").trigger("change"),$("#ti-sell-ot").trigger("change"),$("#setup-stopcontract").html("<h1>You're all set!</h1><p><a href='#' rel='modal:close'><button class='default-btn'>Close</button></a></p>")})})}async function unlockStopContract(){let t=await fetchPermission(String(session.auth.actor)),e=new TextEncoder().encode($("#stop-password").val()),i=buf2hex(await crypto.subtle.digest("SHA-256",e)).substring(0,32),a=eosjs_ecc.PrivateKey.fromHex(window.decryptBytes(t,i).toString()),o="";(await fetchAccount(String(session.auth.actor))).permissions.forEach(t=>{"zeosexecstop"===t.perm_name&&(o=t.required_auth.keys[0].key)}),o!==eosjs_ecc.privateToPublic(a)?alert("wrong password"):(stop_permission={pw:i,key:a.toString()},await fetchStopOrders(),$("a[rel='modal:close']").click())}async function resetStopContract(){let t=[],e=await eosjs_ecc.randomKey(),i=eosjs_ecc.privateToPublic(e);t.push({account:"eosio",name:"updateauth",authorization:[{actor:session.auth.actor,permission:"active"}],data:{account:session.auth.actor,permission:"zeosexecstop",parent:"active",auth:{threshold:1,accounts:[],keys:[{key:i,weight:1}],waits:[]}}});let a=new TextEncoder().encode($("#stop-password").val()),o=buf2hex(await crypto.subtle.digest("SHA-256",a)).substring(0,32),s=window.encryptBytes(buf2hex(eosjs_ecc.PrivateKey.fromString(e).toBuffer()),o);t.push({account:session.auth.actor,name:"setpermkey",authorization:[{actor:session.auth.actor,permission:"active"}],data:{key_ct:s}}),link.transact({actions:t},{broadcast:!0}).then(t=>{stop_permission={pw:o,key:e.toString()},$("#ti-buy-ot").trigger("change"),$("#ti-sell-ot").trigger("change"),$("#unlock-stopcontract").html("<h1>You're all set!</h1><p><a href='#' rel='modal:close'><button class='default-btn'>Close</button></a></p>")})}function market2symbol(t){let e=["Z","L","P","A","A","A","A"],i="Z".charCodeAt()-"A".charCodeAt()+1,a=i*i,o=i*a,s=t,r=Math.floor(t/o),l=Math.floor((s-=r*o)/a),n=Math.floor((s-=l*a)/i),c=s-=n*i;return e[3]=String.fromCharCode(e[3].charCodeAt()+r),e[4]=String.fromCharCode(e[4].charCodeAt()+l),e[5]=String.fromCharCode(e[5].charCodeAt()+n),e[6]=String.fromCharCode(e[6].charCodeAt()+c),e.join("")}function setBuyAmount(t){let e=markets.get(mid),i=window.determineBuyAmount(e.market.base_symbol,e.market.quote_symbol,JSON.stringify(e.market.ask),Math.round(t*Math.pow(10,e.market.price_decimals)).toString(),e.market.amount_base.toString(),e.market.amount_quote.toString(),e.market.price_decimals,e.platform_fee,e.maker_fee);i=parseFloat(i)/Math.pow(10,quote_precision(e)),"limit"!==$("#ti-buy-ot :selected").val()&&$("#ti-buy-ot").val("limit").trigger("change"),$("#ti-buy-price").val(t),$("#ti-buy-total").val(i),$("#ti-buy-amount").val((i/t).toFixed(base_precision(e))),$("#ti-buy-slider").val($("#ti-buy-total").val()/user_balances[1]*100)}function setSellAmount(t){let e=markets.get(mid),i=window.determineSellAmount(e.market.base_symbol,e.market.quote_symbol,JSON.stringify(e.market.bid),Math.round(t*Math.pow(10,e.market.price_decimals)).toString(),e.market.amount_base.toString(),e.market.amount_quote.toString(),e.market.price_decimals,e.platform_fee,e.maker_fee);i=parseFloat(i)/Math.pow(10,base_precision(e)),"limit"!==$("#ti-sell-ot :selected").val()&&$("#ti-sell-ot").val("limit").trigger("change"),$("#ti-sell-price").val(t),$("#ti-sell-amount").val(i),$("#ti-sell-total").val((i*t).toFixed(quote_precision(e))),$("#ti-sell-slider").val($("#ti-sell-amount").val()/user_balances[0]*100)}function findLimitOrders(t,e){let i=[];return t.market.ask.forEach(a=>{a.forEach(a=>{a.owner==e&&i.push({id:a.id,type:"LIMIT SELL",stop_price:"-",limit_price:(a.price/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals),amount_open:(a.amount_open/Math.pow(10,base_precision(t))).toFixed(base_precision(t))+" "+base_symbolcode(t),amount_dealt:(a.amount_dealt/Math.pow(10,quote_precision(t))).toFixed(quote_precision(t))+" "+quote_symbolcode(t),status:0==a.amount_dealt?"Open":0==a.amount_open?"Filled":"Partly Dealt",timestamp:bn2ts(a.block_num)})})}),t.market.bid.forEach(a=>{a.forEach(a=>{a.owner==e&&i.push({id:a.id,type:"LIMIT BUY",stop_price:"-",limit_price:(a.price/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals),amount_open:(a.amount_open/Math.pow(10,quote_precision(t))).toFixed(quote_precision(t))+" "+quote_symbolcode(t),amount_dealt:(a.amount_dealt/Math.pow(10,base_precision(t))).toFixed(base_precision(t))+" "+base_symbolcode(t),status:0==a.amount_dealt?"Open":0==a.amount_open?"Filled":"Partly Dealt",timestamp:bn2ts(a.block_num)})})}),i}const genRandHex=t=>[...Array(t)].map(()=>Math.floor(16*Math.random()).toString(16)).join("");function nextOrderIdHex(){let t=genRandHex(4);for(;limit_orders.filter(e=>e.id===t).length>0||stop_orders.filter(e=>e.id===t).length>0;)t=genRandHex(4);return t}function bn2ts(t){return ref_ts+(t-ref_bn)*500}function ts2bn(t){return ref_bn+(t-ref_ts)/500}function ticks2bars(t,e,i,a){let o=new Map;o.set("1",6e4),o.set("5",3e5),o.set("15",9e5),o.set("30",18e5),o.set("60",36e5),o.set("240",144e5),o.set("1D",864e5);var s=o.get(a);e-=e%s;var r=[];if(i<=e)return r;var l=e;if(0===t.length){for(;l<i;)r.push({time:l,low:0,high:0,open:0,close:0,volume:0}),l+=s;return r}for(var n=0;n<t.length&&bn2ts(t[n].b)<l;)n++;for(;l<i&&n<t.length;){for(;l+s<bn2ts(t[n].b);)r.push({time:l,low:0==n?0:t[n-1].p,high:0==n?0:t[n-1].p,open:0==n?0:t[n-1].p,close:0==n?0:t[n-1].p,volume:0}),l+=s;if(l>=i)return r;for(r.push({time:l,low:r[r.length-1].close,high:r[r.length-1].close,open:r[r.length-1].close,close:r[r.length-1].close,volume:0});n<t.length&&bn2ts(t[n].b)<l+s;)r[r.length-1].low=Math.min(t[n].p,r[r.length-1].low),r[r.length-1].high=Math.max(t[n].p,r[r.length-1].high),r[r.length-1].close=t[n].p,r[r.length-1].volume+=t[n].v,n++;l+=s}for(;l+s<i;)r.push({time:l,low:t[t.length-1].p,high:t[t.length-1].p,open:t[t.length-1].p,close:t[t.length-1].p,volume:0}),l+=s;return r}function top_bar_values(t){let e=t.market.history[t.market.history.length-1].p/Math.pow(10,t.market.price_decimals),i=t.market.history[t.market.history.length-1].b,a=0,o=e,s=i-t.market.history[0].b<=172800?0:e,r=0;for(let l=t.market.history.length-1;l>=0;l--){if(t.market.history[l].b<=i-172800){a=t.market.history[l].p/Math.pow(10,t.market.price_decimals);break}o=Math.max(o,t.market.history[l].p/Math.pow(10,t.market.price_decimals)),s=Math.min(s,t.market.history[l].p/Math.pow(10,t.market.price_decimals)),r+=t.market.history[l].v/Math.pow(10,base_precision(t))}return{last_price:e,h24_change:(e/a-1)*100,h24_high:o,h24_low:s,h24_volume:r}}function updateUI(){let t=markets.get(mid);$(".bsym").html(base_symbolcode(t)),$(".qsym").html(quote_symbolcode(t)),$(".ssym").html(market2symbol(t.id));let e=top_bar_values(t);$("#lastprice").html(e.last_price.toFixed(t.market.price_decimals)),$("#lp-td").attr("class","tb-item"),t.market.history.length>=2&&$("#lp-td").addClass("price").addClass(t.market.history[t.market.history.length-1-1].p<t.market.history[t.market.history.length-1].p?"buy":t.market.history[t.market.history.length-1-1].p>t.market.history[t.market.history.length-1].p?"sell":""),$("#h24change").html((e.h24_change>0?"+":"")+e.h24_change.toFixed(2)+"%"),$("#h24change").attr("class","price"),$("#h24change").addClass(e.h24_change>0?"buy":e.h24_change<0?"sell":""),$("#h24high").html(e.h24_high.toFixed(t.market.price_decimals)),$("#h24low").html(e.h24_low.toFixed(t.market.price_decimals)),$("#h24volume").html(e.h24_volume.toFixed(base_precision(t)));let i=t.market.amount_base/Math.pow(10,base_precision(t));t.market.ask.forEach(e=>{let a=0;e.forEach(e=>{a+=e.amount_open/Math.pow(10,base_precision(t))}),i=Math.max(i,a)});let a=t.market.amount_quote/Math.pow(10,quote_precision(t));t.market.bid.forEach(e=>{let i=0;e.forEach(e=>{i+=e.amount_open/Math.pow(10,quote_precision(t))}),a=Math.max(a,i)}),$("#book-ask > tbody").empty();for(let o=0;o<24-t.market.ask.length;o++)$("#book-ask > tbody").append("<tr><td>&nbsp;</td><td></td><td></td></tr>");for(let s=t.market.ask.length-1;s>=0;s--){let r=0;t.market.ask[s].forEach(t=>{r+=t.amount_open}),r/=Math.pow(10,base_precision(t));let l=t.market.ask[s][0].price/Math.pow(10,t.market.price_decimals);$("#book-ask > tbody").append("<tr onclick='window.setBuyAmount("+l.toFixed(t.market.price_decimals)+")'><td class='price sell'>"+l.toFixed(t.market.price_decimals)+"</td><td>"+r.toFixed(base_precision(t))+"</td><td>"+(r*l).toFixed(t.market.price_decimals)+"<i class='depth-bar ask' style='width:"+(r/i*100).toFixed(2)+"%;'></i></td></tr>")}let n=$("#book-ask > tbody").get(0);n.scrollTo(0,n.offsetHeight),$(".poolprice").html((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$(".poolamountbase").html(t.market.amount_base/Math.pow(10,base_precision(t))+"<i class='depth-bar ask' style='width:"+(t.market.amount_base/Math.pow(10,base_precision(t))/i*100).toFixed(2)+"%;'></i>"),$(".poolamountquote").html(t.market.amount_quote/Math.pow(10,quote_precision(t))+"<i class='depth-bar bid' style='width:"+(t.market.amount_quote/Math.pow(10,quote_precision(t))/a*100).toFixed(2)+"%;'></i>"),$("#book-bid > tbody").empty(),t.market.bid.forEach(e=>{let i=0;e.forEach(t=>{i+=t.amount_open}),i/=Math.pow(10,quote_precision(t));let o=e[0].price/Math.pow(10,t.market.price_decimals);$("#book-bid > tbody").append("<tr onclick='window.setSellAmount("+o.toFixed(t.market.price_decimals)+")'><td class='price buy'>"+o.toFixed(t.market.price_decimals)+"</td><td>"+(i/o).toFixed(t.market.price_decimals)+"</td><td>"+i.toFixed(quote_precision(t))+"<i class='depth-bar bid' style='width:"+(i/a*100).toFixed(2)+"%;'></i></td></tr>")}),$("#latest-deals > tbody").empty();for(let c=t.market.history.length-1;c>=1;c--)$("#latest-deals > tbody").append("<tr><td>"+(1&t.market.history[c].t?"Book":"Pool")+"</td><td class='price "+(t.market.history[c-1].p<t.market.history[c].p?"buy":t.market.history[c-1].p>t.market.history[c].p?"sell":"")+"'>"+(t.market.history[c].p/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals)+"</td><td class='price "+(2&t.market.history[c].t?"buy":"sell")+"'>"+(t.market.history[c].v/Math.pow(10,base_precision(t))).toFixed(base_precision(t))+"</td><td>"+new Date(bn2ts(t.market.history[c].b)).toISOString().substring(0,19).replace("T"," ")+"</td></tr>");if($("#open-orders > tbody").empty(),null!==session){limit_orders=findLimitOrders(t,String(session.auth.actor));let u=stop_orders.filter(e=>e.market_id===t.id).map(e=>{let i=e.amount.substring(e.amount.indexOf(" ")+1)===t.market.quote_symbol.substring(t.market.quote_symbol.indexOf(",")+1),a=!(2147483647===e.limit_price||1===e.limit_price),o;return i&&a&&(o="STOP-LIMIT BUY"),i&&!a&&(o="STOP BUY"),!i&&a&&(o="STOP-LIMIT SELL"),i||a||(o="STOP SELL"),{id:e.id,type:o,stop_price:(e.stop_price/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals),limit_price:a?(e.limit_price/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals):"-",amount_open:e.amount,amount_dealt:"-",status:"Open",timestamp:e.timestamp}});(u=[...u,...limit_orders]).sort((t,e)=>t.timestamp<e.timestamp?1:t.timestamp>e.timestamp?-1:0),u.forEach(e=>{$("#open-orders > tbody").append("<tr><td>"+e.id+"</td>"+(-1!==e.type.indexOf("SELL")?"<td class='price sell'>"+e.type:"<td class='price buy'>"+e.type)+"</td><td>"+e.stop_price+"</td><td>"+e.limit_price+"</td><td>"+e.amount_open+"</td><td>"+e.amount_dealt+"</td><td>"+e.status+"</td><td>"+new Date(e.timestamp).toISOString().substring(0,19).replace("T"," ")+"</td><td><img src='cancel-icon.png' width='15' height='15' onclick='cancelOrder(\""+t.id+'","'+e.id+'",'+(-1!==e.type.indexOf("BUY"))+","+(-1!==e.type.indexOf("STOP"))+")' /></td></tr>")})}if("market"===$("#ti-buy-ot :selected").val()){let m='{"amount_open":'+parseInt($("#ti-buy-total").val()*Math.pow(10,quote_precision(t)))+',"amount_dealt":0,"price":2147483647,"owner":"owner","id":"id","block_num":0}',p=JSON.parse(window.marketBuy(t.market.base_symbol,t.market.quote_symbol,JSON.stringify(t.market.ask),m,t.market.amount_base.toString(),t.market.amount_quote.toString(),t.market.price_decimals,t.platform_fee,t.maker_fee));$("#ti-buy-amount").val((parseInt(p.amount_dealt)/Math.pow(10,base_precision(t))).toFixed(base_precision(t))),$("#ti-buy-amount").val()>0?$("#ti-buy-price").val(($("#ti-buy-total").val()/$("#ti-buy-amount").val()).toFixed(t.market.price_decimals)):($("#ti-buy-price").val(""),$("#ti-buy-amount").val(""),$("#ti-buy-total").val(""))}if("market"===$("#ti-sell-ot :selected").val()){let d='{"amount_open":'+parseInt($("#ti-sell-amount").val()*Math.pow(10,base_precision(t)))+',"amount_dealt":0,"price":0,"owner":"owner","id":"id","block_num":0}',b=JSON.parse(window.marketSell(t.market.base_symbol,t.market.quote_symbol,JSON.stringify(t.market.bid),d,t.market.amount_base.toString(),t.market.amount_quote.toString(),t.market.price_decimals,t.platform_fee,t.maker_fee));$("#ti-sell-total").val((parseInt(b.amount_dealt)/Math.pow(10,quote_precision(t))).toFixed(quote_precision(t))),$("#ti-sell-amount").val()>0?$("#ti-sell-price").val(($("#ti-sell-total").val()/$("#ti-sell-amount").val()).toFixed(t.market.price_decimals)):($("#ti-sell-price").val(""),$("#ti-sell-amount").val(""),$("#ti-sell-total").val(""))}}function resetBuyInput(){let t=markets.get(mid);$("#ti-buy-ot").trigger("change"),$("#ti-buy-stop-price").attr("step",1/Math.pow(10,t.market.price_decimals)),$("#ti-buy-price").attr("step",1/Math.pow(10,t.market.price_decimals)),$("#ti-buy-price").off("input").on("input",function(){$("#ti-buy-total").val()&&$("#ti-buy-amount").val(($("#ti-buy-total").val()/$("#ti-buy-price").val()).toFixed(base_precision(t)))}),$("#ti-buy-amount").off("input").on("input",function(){$("#ti-buy-price").val()||$("#ti-buy-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$("#ti-buy-stop-price").val()||$("#ti-buy-stop-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))+1/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals)),$("#ti-buy-total").val(($("#ti-buy-amount").val()*$("#ti-buy-price").val()).toFixed(quote_precision(t))),$("#ti-buy-slider").val($("#ti-buy-total").val()/user_balances[1]*100);let e=$("#ti-buy-amount").val();setTimeout(async()=>{e===$("#ti-buy-amount").val()&&0==$("#ti-buy-amount").val()&&($("#ti-buy-stop-price").val(""),$("#ti-buy-price").val(""),$("#ti-buy-amount").val(""),$("#ti-buy-total").val(""))},3e3)}),$("#ti-buy-total").off("input").on("input",function(){let t=markets.get(mid);if($("#ti-buy-slider").val($("#ti-buy-total").val()/user_balances[1]*100),"market"===$("#ti-buy-ot :selected").val()){let e='{"amount_open":'+parseInt($("#ti-buy-total").val()*Math.pow(10,quote_precision(t)))+',"amount_dealt":0,"price":2147483647,"owner":"owner","id":"id","block_num":0}',i=JSON.parse(window.marketBuy(t.market.base_symbol,t.market.quote_symbol,JSON.stringify(t.market.ask),e,t.market.amount_base.toString(),t.market.amount_quote.toString(),t.market.price_decimals,t.platform_fee,t.maker_fee));$("#ti-buy-amount").val((parseInt(i.amount_dealt)/Math.pow(10,base_precision(t))).toFixed(base_precision(t))),$("#ti-buy-amount").val()>0&&$("#ti-buy-price").val(($("#ti-buy-total").val()/$("#ti-buy-amount").val()).toFixed(t.market.price_decimals))}else("limit"===$("#ti-buy-ot :selected").val()||"stoplimit"===$("#ti-buy-ot :selected").val())&&($("#ti-buy-price").val()||$("#ti-buy-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$("#ti-buy-amount").val(($("#ti-buy-total").val()/$("#ti-buy-price").val()).toFixed(base_precision(t))));$("#ti-buy-stop-price").val()||$("#ti-buy-stop-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))+1/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals));let a=$("#ti-buy-total").val();setTimeout(async()=>{a===$("#ti-buy-total").val()&&0==$("#ti-buy-total").val()&&($("#ti-buy-stop-price").val(""),$("#ti-buy-price").val(""),$("#ti-buy-amount").val(""),$("#ti-buy-total").val(""))},3e3)}),$("#ti-buy-slider").off("input").on("input",function(){let t=markets.get(mid);if($("#ti-buy-total").val(($("#ti-buy-slider").val()/100*user_balances[1]).toFixed(quote_precision(t))),"market"===$("#ti-buy-ot :selected").val()){let e='{"amount_open":'+parseInt($("#ti-buy-total").val()*Math.pow(10,quote_precision(t)))+',"amount_dealt":0,"price":2147483647,"owner":"owner","id":"id","block_num":0}',i=JSON.parse(window.marketBuy(t.market.base_symbol,t.market.quote_symbol,JSON.stringify(t.market.ask),e,t.market.amount_base.toString(),t.market.amount_quote.toString(),t.market.price_decimals,t.platform_fee,t.maker_fee));$("#ti-buy-amount").val((parseInt(i.amount_dealt)/Math.pow(10,base_precision(t))).toFixed(base_precision(t))),$("#ti-buy-amount").val()>0&&$("#ti-buy-price").val(($("#ti-buy-total").val()/$("#ti-buy-amount").val()).toFixed(t.market.price_decimals))}else("limit"===$("#ti-buy-ot :selected").val()||"stoplimit"===$("#ti-buy-ot :selected").val())&&($("#ti-buy-price").val()||$("#ti-buy-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$("#ti-buy-amount").val(($("#ti-buy-total").val()/$("#ti-buy-price").val()).toFixed(base_precision(t))));$("#ti-buy-stop-price").val()||$("#ti-buy-stop-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))+1/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals)),0==$("#ti-buy-total").val()&&($("#ti-buy-stop-price").val(""),$("#ti-buy-price").val(""),$("#ti-buy-amount").val(""),$("#ti-buy-total").val(""))}),$("#ti-buy-ot").unbind("change").bind("change",function(){switch($(this).val()){case"market":$("#ti-buy-stop-price").hide(),$("#ti-buy-stop-price-suffix").hide(),$("#ti-buy-price").show(),$("#ti-buy-price").val(""),$("#ti-buy-price").attr("disabled","disabled"),$("#ti-buy-price-suffix").show(),$("#ti-buy-amount").show(),$("#ti-buy-amount").val(""),$("#ti-buy-amount").attr("disabled","disabled"),$("#ti-buy-amount-suffix").show(),$("#ti-buy-slider").val(0),$("#ti-buy-slider").show(),$("#ti-buy-total").val(""),$("#ti-buy-total").show(),$("#ti-buy-total-suffix").show(),$("#ti-buy-btn").show(),$("#ti-buy-enable-btn").hide();break;case"limit":$("#ti-buy-stop-price").hide(),$("#ti-buy-stop-price-suffix").hide(),$("#ti-buy-price").show(),$("#ti-buy-price").val(""),$("#ti-buy-price").removeAttr("disabled"),$("#ti-buy-price-suffix").show(),$("#ti-buy-amount").show(),$("#ti-buy-amount").val(""),$("#ti-buy-amount").removeAttr("disabled"),$("#ti-buy-slider").val(0),$("#ti-buy-slider").show(),$("#ti-buy-total").val(""),$("#ti-buy-total").show(),$("#ti-buy-total-suffix").show(),$("#ti-buy-btn").show(),$("#ti-buy-enable-btn").hide();break;case"stop":null!==session&&null===stop_permission?($("#ti-buy-stop-price").hide(),$("#ti-buy-stop-price-suffix").hide(),$("#ti-buy-price").hide(),$("#ti-buy-price-suffix").hide(),$("#ti-buy-amount").hide(),$("#ti-buy-amount-suffix").hide(),$("#ti-buy-slider").hide(),$("#ti-buy-total").hide(),$("#ti-buy-total-suffix").hide(),$("#ti-buy-btn").hide(),$("#ti-buy-enable-btn").show()):($("#ti-buy-stop-price").show(),$("#ti-buy-stop-price").val(""),$("#ti-buy-stop-price-suffix").show(),$("#ti-buy-price").hide(),$("#ti-buy-price-suffix").hide(),$("#ti-buy-amount").hide(),$("#ti-buy-amount-suffix").hide(),$("#ti-buy-slider").val(0),$("#ti-buy-slider").show(),$("#ti-buy-total").show(),$("#ti-buy-total").val(""),$("#ti-buy-total-suffix").show(),$("#ti-buy-btn").show(),$("#ti-buy-enable-btn").hide());break;case"stoplimit":null!==session&&null===stop_permission?($("#ti-buy-stop-price").hide(),$("#ti-buy-stop-price-suffix").hide(),$("#ti-buy-price").hide(),$("#ti-buy-price-suffix").hide(),$("#ti-buy-amount").hide(),$("#ti-buy-amount-suffix").hide(),$("#ti-buy-slider").hide(),$("#ti-buy-total").hide(),$("#ti-buy-total-suffix").hide(),$("#ti-buy-btn").hide(),$("#ti-buy-enable-btn").show()):($("#ti-buy-stop-price").show(),$("#ti-buy-stop-price").val(""),$("#ti-buy-stop-price-suffix").show(),$("#ti-buy-price").show(),$("#ti-buy-price").val(""),$("#ti-buy-price").removeAttr("disabled"),$("#ti-buy-price-suffix").show(),$("#ti-buy-amount").show(),$("#ti-buy-amount").val(""),$("#ti-buy-amount").removeAttr("disabled"),$("#ti-buy-amount-suffix").show(),$("#ti-buy-slider").val(0),$("#ti-buy-slider").show(),$("#ti-buy-total").show(),$("#ti-buy-total").val(""),$("#ti-buy-total-suffix").show(),$("#ti-buy-btn").show(),$("#ti-buy-enable-btn").hide())}}),$("#ti-buy-btn").off("click").on("click",function(){if(null===session){$("#login").modal("show");return}let t=markets.get(mid),e;switch($("#ti-buy-ot").val()){case"limit":case"market":e={account:t.market.quote_symbol_contract,name:"transfer",authorization:[{actor:session.auth.actor,permission:"active"}],data:{from:session.auth.actor,to:"zeosexchange",quantity:parseFloat($("#ti-buy-total").val()).toFixed(quote_precision(t))+" "+quote_symbolcode(t),memo:""}},"limit"===$("#ti-buy-ot").val()&&(e.data.memo="exchange "+t.id+" "+parseFloat($("#ti-buy-price").val()).toFixed(t.market.price_decimals).replace(".","")+" "+nextOrderIdHex()),"market"===$("#ti-buy-ot").val()&&(e.data.memo="exchange "+t.id+" 2147483647 "+nextOrderIdHex());break;case"stop":case"stoplimit":if(null===stop_permission){alert("Stop-Orders not enabled");return}if(parseFloat($("#ti-buy-stop-price").val())<=parseFloat((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals))){alert("Stop-Price must be greater than current market price");return}let i=genRandHex(32),a=window.encryptOrder(t.id.toString(),parseFloat($("#ti-buy-total").val()).toFixed(quote_precision(t)).replace(".",""),t.market.quote_symbol,t.market.quote_symbol_contract,parseFloat($("#ti-buy-stop-price").val()).toFixed(t.market.price_decimals).replace(".",""),"stop"===$("#ti-buy-ot").val()?2147483647..toString():parseFloat($("#ti-buy-price").val()).toFixed(t.market.price_decimals).replace(".",""),Date.now().toString(),i),o=window.encryptBytes(i,stop_permission.pw);e={account:session.auth.actor,name:"addorder",authorization:[{actor:session.auth.actor,permission:"active"}],data:{id:nextOrderIdHex(),aes_key_ct:o,order_ct:a}}}link.transact({action:e},{broadcast:!0}).then(t=>{setTimeout(async()=>{await fetchMarket(mid),await fetchStopOrders(),updateUI(),fetchBalances(),resetBuyInput(),resetSellInput()},3e3)})})}function resetSellInput(){let t=markets.get(mid);$("#ti-sell-ot").trigger("change"),$("#ti-sell-stop-price").attr("step",1/Math.pow(10,t.market.price_decimals)),$("#ti-sell-price").attr("step",1/Math.pow(10,t.market.price_decimals)),$("#ti-sell-price").off("input").on("input",function(){$("#ti-sell-amount").val()&&$("#ti-sell-total").val(($("#ti-sell-amount").val()*$("#ti-sell-price").val()).toFixed(quote_precision(t)))}),$("#ti-sell-total").off("input").on("input",function(){$("#ti-sell-price").val()||$("#ti-sell-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$("#ti-sell-stop-price").val()||$("#ti-sell-stop-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))-1/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals)),$("#ti-sell-amount").val(($("#ti-sell-total").val()/$("#ti-sell-price").val()).toFixed(base_precision(t))),$("#ti-sell-slider").val($("#ti-sell-amount").val()/user_balances[0]*100);let e=$("#ti-sell-total").val();setTimeout(async()=>{e===$("#ti-sell-total").val()&&0==$("#ti-sell-total").val()&&($("#ti-sell-stop-price").val(""),$("#ti-sell-price").val(""),$("#ti-sell-amount").val(""),$("#ti-sell-total").val(""))},3e3)}),$("#ti-sell-amount").off("input").on("input",function(){let t=markets.get(mid);if($("#ti-sell-slider").val($("#ti-sell-amount").val()/user_balances[0]*100),"market"===$("#ti-sell-ot :selected").val()){let e='{"amount_open":'+parseInt($("#ti-sell-amount").val()*Math.pow(10,base_precision(t)))+',"amount_dealt":0,"price":0,"owner":"owner","id":"id","block_num":0}',i=JSON.parse(window.marketSell(t.market.base_symbol,t.market.quote_symbol,JSON.stringify(t.market.bid),e,t.market.amount_base.toString(),t.market.amount_quote.toString(),t.market.price_decimals,t.platform_fee,t.maker_fee));$("#ti-sell-total").val((parseInt(i.amount_dealt)/Math.pow(10,quote_precision(t))).toFixed(quote_precision(t))),$("#ti-sell-amount").val()>0&&$("#ti-sell-price").val(($("#ti-sell-total").val()/$("#ti-sell-amount").val()).toFixed(t.market.price_decimals))}else("limit"===$("#ti-sell-ot :selected").val()||"stoplimit"===$("#ti-sell-ot :selected").val())&&($("#ti-sell-price").val()||$("#ti-sell-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$("#ti-sell-total").val(($("#ti-sell-amount").val()*$("#ti-sell-price").val()).toFixed(quote_precision(t))));$("#ti-sell-stop-price").val()||$("#ti-sell-stop-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))-1/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals));let a=$("#ti-sell-amount").val();setTimeout(async()=>{a===$("#ti-sell-amount").val()&&0==$("#ti-sell-amount").val()&&($("#ti-sell-stop-price").val(""),$("#ti-sell-price").val(""),$("#ti-sell-amount").val(""),$("#ti-sell-total").val(""))},3e3)}),$("#ti-sell-slider").off("input").on("input",function(){let t=markets.get(mid);if($("#ti-sell-amount").val(($("#ti-sell-slider").val()/100*user_balances[0]).toFixed(base_precision(t))),"market"===$("#ti-sell-ot :selected").val()){let e='{"amount_open":'+parseInt($("#ti-sell-amount").val()*Math.pow(10,base_precision(t)))+',"amount_dealt":0,"price":0,"owner":"owner","id":"id","block_num":0}',i=JSON.parse(window.marketSell(t.market.base_symbol,t.market.quote_symbol,JSON.stringify(t.market.bid),e,t.market.amount_base.toString(),t.market.amount_quote.toString(),t.market.price_decimals,t.platform_fee,t.maker_fee));$("#ti-sell-total").val((parseInt(i.amount_dealt)/Math.pow(10,quote_precision(t))).toFixed(quote_precision(t))),$("#ti-sell-amount").val()>0&&$("#ti-sell-price").val(($("#ti-sell-total").val()/$("#ti-sell-amount").val()).toFixed(t.market.price_decimals))}else("limit"===$("#ti-sell-ot :selected").val()||"stoplimit"===$("#ti-sell-ot :selected").val())&&($("#ti-sell-price").val()||$("#ti-sell-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals)),$("#ti-sell-total").val(($("#ti-sell-amount").val()*$("#ti-sell-price").val()).toFixed(quote_precision(t))));$("#ti-sell-stop-price").val()||$("#ti-sell-stop-price").val((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))-1/Math.pow(10,t.market.price_decimals)).toFixed(t.market.price_decimals)),0==$("#ti-sell-amount").val()&&($("#ti-sell-stop-price").val(""),$("#ti-sell-price").val(""),$("#ti-sell-amount").val(""),$("#ti-sell-total").val(""))}),$("#ti-sell-ot").unbind("change").bind("change",function(){switch($(this).val()){case"market":$("#ti-sell-stop-price").hide(),$("#ti-sell-stop-price-suffix").hide(),$("#ti-sell-price").show(),$("#ti-sell-price").val(""),$("#ti-sell-price").attr("disabled","disabled"),$("#ti-sell-price-suffix").show(),$("#ti-sell-total").show(),$("#ti-sell-total").val(""),$("#ti-sell-total").attr("disabled","disabled"),$("#ti-sell-total-suffix").show(),$("#ti-sell-slider").val(0),$("#ti-sell-slider").show(),$("#ti-sell-amount").val(""),$("#ti-sell-amount").show(),$("#ti-sell-amount-suffix").show(),$("#ti-sell-btn").show(),$("#ti-sell-enable-btn").hide();break;case"limit":$("#ti-sell-stop-price").hide(),$("#ti-sell-stop-price-suffix").hide(),$("#ti-sell-price").show(),$("#ti-sell-price").val(""),$("#ti-sell-price").removeAttr("disabled"),$("#ti-sell-price-suffix").show(),$("#ti-sell-amount").show(),$("#ti-sell-amount").val(""),$("#ti-sell-amount").removeAttr("disabled"),$("#ti-sell-slider").val(0),$("#ti-sell-slider").show(),$("#ti-sell-total").show(),$("#ti-sell-total").val(""),$("#ti-sell-total").removeAttr("disabled"),$("#ti-sell-total-suffix").show(),$("#ti-sell-btn").show(),$("#ti-sell-enable-btn").hide();break;case"stop":null!==session&&null===stop_permission?($("#ti-sell-stop-price").hide(),$("#ti-sell-stop-price-suffix").hide(),$("#ti-sell-price").hide(),$("#ti-sell-price-suffix").hide(),$("#ti-sell-amount").hide(),$("#ti-sell-amount-suffix").hide(),$("#ti-sell-slider").hide(),$("#ti-sell-total").hide(),$("#ti-sell-total-suffix").hide(),$("#ti-sell-btn").hide(),$("#ti-sell-enable-btn").show()):($("#ti-sell-stop-price").show(),$("#ti-sell-stop-price").val(""),$("#ti-sell-stop-price-suffix").show(),$("#ti-sell-price").hide(),$("#ti-sell-price-suffix").hide(),$("#ti-sell-amount").show(),$("#ti-sell-amount").val(""),$("#ti-sell-amount-suffix").show(),$("#ti-sell-slider").val(0),$("#ti-sell-slider").show(),$("#ti-sell-total").hide(),$("#ti-sell-total-suffix").hide(),$("#ti-sell-btn").show(),$("#ti-sell-enable-btn").hide());break;case"stoplimit":null!==session&&null===stop_permission?($("#ti-sell-stop-price").hide(),$("#ti-sell-stop-price-suffix").hide(),$("#ti-sell-price").hide(),$("#ti-sell-price-suffix").hide(),$("#ti-sell-amount").hide(),$("#ti-sell-amount-suffix").hide(),$("#ti-sell-slider").hide(),$("#ti-sell-total").hide(),$("#ti-sell-total-suffix").hide(),$("#ti-sell-btn").hide(),$("#ti-sell-enable-btn").show()):($("#ti-sell-stop-price").show(),$("#ti-sell-stop-price").val(""),$("#ti-sell-stop-price-suffix").show(),$("#ti-sell-price").show(),$("#ti-sell-price").val(""),$("#ti-sell-price").removeAttr("disabled"),$("#ti-sell-price-suffix").show(),$("#ti-sell-amount").show(),$("#ti-sell-amount").val(""),$("#ti-sell-amount").removeAttr("disabled"),$("#ti-sell-amount-suffix").show(),$("#ti-sell-slider").val(0),$("#ti-sell-slider").show(),$("#ti-sell-total").show(),$("#ti-sell-total").val(""),$("#ti-sell-total-suffix").show(),$("#ti-sell-btn").show(),$("#ti-sell-enable-btn").hide())}}),$("#ti-sell-btn").off("click").on("click",function(){if(null===session){$("#login").modal("show");return}let t=markets.get(mid),e;switch($("#ti-sell-ot").val()){case"limit":case"market":e={account:t.market.base_symbol_contract,name:"transfer",authorization:[{actor:session.auth.actor,permission:"active"}],data:{from:session.auth.actor,to:"zeosexchange",quantity:parseFloat($("#ti-sell-amount").val()).toFixed(base_precision(t))+" "+base_symbolcode(t),memo:""}},"limit"===$("#ti-sell-ot").val()&&(e.data.memo="exchange "+t.id+" "+parseFloat($("#ti-sell-price").val()).toFixed(t.market.price_decimals).replace(".","")+" "+nextOrderIdHex()),"market"===$("#ti-sell-ot").val()&&(e.data.memo="exchange "+t.id+" 1 "+nextOrderIdHex());break;case"stop":case"stoplimit":if(null===stop_permission){alert("Stop-Orders not enabled");return}if(parseFloat($("#ti-sell-stop-price").val())>=parseFloat((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals))){alert("Stop-Price must be lesser than current market price");return}let i=genRandHex(32),a=window.encryptOrder(t.id.toString(),parseFloat($("#ti-sell-amount").val()).toFixed(base_precision(t)).replace(".",""),t.market.base_symbol,t.market.base_symbol_contract,parseFloat($("#ti-sell-stop-price").val()).toFixed(t.market.price_decimals).replace(".",""),"stop"===$("#ti-sell-ot").val()?1..toString():parseFloat($("#ti-sell-price").val()).toFixed(t.market.price_decimals).replace(".",""),Date.now().toString(),i),o=window.encryptBytes(i,stop_permission.pw);e={account:session.auth.actor,name:"addorder",authorization:[{actor:session.auth.actor,permission:"active"}],data:{id:nextOrderIdHex(),aes_key_ct:o,order_ct:a}}}link.transact({action:e},{broadcast:!0}).then(t=>{setTimeout(async()=>{await fetchMarket(mid),await fetchStopOrders(),updateUI(),fetchBalances(),resetSellInput(),resetBuyInput()},3e3)})})}function resetDepositInput(){$("#li-base-amount").val(""),$("#li-quote-amount").val(""),$("#li-deposit-slider").val(0),$("#li-receive-shares").val(""),$("#li-base-amount").off("input").on("input",function(){let t=markets.get(mid),e=t.market.amount_quote/Math.pow(10,quote_precision(t)),i=t.market.amount_base/Math.pow(10,base_precision(t)),a=e/t.market.amount_shares,o=i/t.market.amount_shares,s=user_balances[1]/(e/i),r=user_balances[0]>=s?"base":"quote";$("#li-quote-amount").val(($("#li-base-amount").val()/o*a).toFixed(quote_precision(t))),$("#li-receive-shares").val(($("#li-base-amount").val()/o).toFixed(0)),"quote"===r?$("#li-deposit-slider").val($("#li-base-amount").val()/user_balances[0]*100):$("#li-deposit-slider").val($("#li-quote-amount").val()/user_balances[1]*100);let l=$("#li-base-amount").val();setTimeout(async()=>{l===$("#li-base-amount").val()&&0==$("#li-base-amount").val()&&($("#li-base-amount").val(""),$("#li-quote-amount").val(""),$("#li-receive-shares").val(""))},3e3)}),$("#li-quote-amount").off("input").on("input",function(){let t=markets.get(mid),e=t.market.amount_quote/Math.pow(10,quote_precision(t)),i=t.market.amount_base/Math.pow(10,base_precision(t)),a=e/t.market.amount_shares,o=i/t.market.amount_shares,s=user_balances[1]/(e/i),r=user_balances[0]>=s?"base":"quote";$("#li-base-amount").val(($("#li-quote-amount").val()/a*o).toFixed(base_precision(t))),$("#li-receive-shares").val(($("#li-quote-amount").val()/a).toFixed(0)),"quote"===r?$("#li-deposit-slider").val($("#li-base-amount").val()/user_balances[0]*100):$("#li-deposit-slider").val($("#li-quote-amount").val()/user_balances[1]*100);let l=$("#li-quote-amount").val();setTimeout(async()=>{l===$("#li-quote-amount").val()&&0==$("#li-quote-amount").val()&&($("#li-base-amount").val(""),$("#li-quote-amount").val(""),$("#li-receive-shares").val(""))},3e3)}),$("#li-deposit-slider").off("input").on("input",function(){let t=markets.get(mid),e=t.market.amount_quote/Math.pow(10,quote_precision(t)),i=t.market.amount_base/Math.pow(10,base_precision(t)),a=e/t.market.amount_shares,o=i/t.market.amount_shares,s=user_balances[1]/(e/i);"quote"==(user_balances[0]>=s?"base":"quote")?($("#li-base-amount").val(($("#li-deposit-slider").val()/100*user_balances[0]).toFixed(base_precision(t))),$("#li-receive-shares").val(($("#li-base-amount").val()/o).toFixed(0)),$("#li-quote-amount").val(($("#li-receive-shares").val()*a).toFixed(quote_precision(t)))):($("#li-quote-amount").val(($("#li-deposit-slider").val()/100*user_balances[1]).toFixed(quote_precision(t))),$("#li-receive-shares").val(($("#li-quote-amount").val()/a).toFixed(0)),$("#li-base-amount").val(($("#li-receive-shares").val()*o).toFixed(base_precision(t)))),0==$("#li-base-amount").val()&&($("#li-base-amount").val(""),$("#li-quote-amount").val(""),$("#li-receive-shares").val(""))}),$("#li-deposit-btn").off("click").on("click",function(){if(null===session){$("#login").modal("show");return}let t=markets.get(mid),e=[{account:t.market.base_symbol_contract,name:"transfer",authorization:[{actor:session.auth.actor,permission:"active"}],data:{from:session.auth.actor,to:"zeosexchange",quantity:parseFloat($("#li-base-amount").val()).toFixed(base_precision(t))+" "+base_symbolcode(t),memo:"base"}},{account:t.market.quote_symbol_contract,name:"transfer",authorization:[{actor:session.auth.actor,permission:"active"}],data:{from:session.auth.actor,to:"zeosexchange",quantity:parseFloat($("#li-quote-amount").val()).toFixed(quote_precision(t))+" "+quote_symbolcode(t),memo:"liquidity "+t.id}}];link.transact({actions:e},{broadcast:!0}).then(t=>{setTimeout(async()=>{await fetchMarket(mid),updateUI(),fetchBalances(),resetDepositInput(),resetWithdrawInput()},3e3)})})}function resetWithdrawInput(){$("#li-shares-amount").val(""),$("#li-withdraw-slider").val(0),$("#li-receive-base").val(""),$("#li-receive-quote").val(""),$("#li-shares-amount").off("input").on("input",function(){let t=markets.get(mid),e=t.market.amount_quote/Math.pow(10,quote_precision(t)),i=t.market.amount_base/Math.pow(10,base_precision(t)),a=e/t.market.amount_shares,o=i/t.market.amount_shares;$("#li-withdraw-slider").val($("#li-shares-amount").val()/user_balances[2]*100),$("#li-receive-base").val(($("#li-shares-amount").val()*o).toFixed(base_precision(t))),$("#li-receive-quote").val(($("#li-shares-amount").val()*a).toFixed(quote_precision(t))),0==$(this).val()&&($("#li-shares-amount").val(""),$("#li-receive-base").val(""),$("#li-receive-quote").val(""))}),$("#li-withdraw-slider").off("input").on("input",function(){let t=markets.get(mid),e=t.market.amount_quote/Math.pow(10,quote_precision(t)),i=t.market.amount_base/Math.pow(10,base_precision(t)),a=e/t.market.amount_shares,o=i/t.market.amount_shares;$("#li-shares-amount").val(($("#li-withdraw-slider").val()/100*user_balances[2]).toFixed(0)),$("#li-receive-base").val(($("#li-shares-amount").val()*o).toFixed(base_precision(t))),$("#li-receive-quote").val(($("#li-shares-amount").val()*a).toFixed(quote_precision(t))),0==$("#li-shares-amount").val()&&($("#li-shares-amount").val(""),$("#li-receive-base").val(""),$("#li-receive-quote").val(""))}),$("#li-withdraw-btn").off("click").on("click",function(){if(null===session){$("#login").modal("show");return}let t=markets.get(mid),e={account:"zeosexchange",name:"transfer",authorization:[{actor:session.auth.actor,permission:"active"}],data:{from:session.auth.actor,to:"zeosexchange",quantity:parseFloat($("#li-shares-amount").val()).toFixed(0)+" "+market2symbol(t.id),memo:""}};link.transact({action:e},{broadcast:!0}).then(t=>{setTimeout(async()=>{await fetchMarket(mid),updateUI(),fetchBalances(),resetWithdrawInput(),resetDepositInput()},3e3)})})}function cancelOrder(t,e,i,a){let o;o=a?{account:session.auth.actor,name:"rmorder",authorization:[{actor:session.auth.actor,permission:"active"}],data:{id:e}}:{account:"zeosexchange",name:"cancelorder",authorization:[{actor:session.auth.actor,permission:"active"}],data:{market_id:t,user:session.auth.actor,order_id:e,is_bid:i,proof_bytes:""}},link.transact({action:o},{broadcast:!0}).then(t=>{setTimeout(async()=>{await fetchStopOrders(),await fetchMarket(mid),updateUI(),fetchBalances()},3e3)})}async function archiveTicks(){if(null===session){alert("Archive market history only with Anchor.");return}let t=markets.get(mid),e;if(0===t.history_blocks.length)e=t.market.history;else{let i;await $.post("/history",{id:mid,num:t.history_blocks[t.history_blocks.length-1]},(t,e,a)=>{i=t[t.length-1]},"json");let a=0;for(;JSON.stringify(t.market.history[a])!==JSON.stringify(i);)a++;e=t.market.history.slice(a+1,-2)}for(;0!=e.length&&e[e.length-1].b>=ts2bn(Date.now())-172800;)e.pop();if(e.pop(),e.length<t.ticks_per_block){alert("Not enough market history to archive yet. Need "+(t.ticks_per_block-e.length)+" more deals older than 24 hours.");return}let o={account:"zeosexchange",name:"archiveticks",authorization:[{actor:session.auth.actor,permission:"active"}],data:{market_id:mid,history:e}};link.transact({action:o},{broadcast:!0}).then(t=>{console.log("Successfully archived "+e.length+" deals on chain.")})}function executeStopOrders(){if(null===session||null===stop_permission)return;let t=markets.get(mid),e=parseFloat((t.market.amount_quote/Math.pow(10,quote_precision(t))/(t.market.amount_base/Math.pow(10,base_precision(t)))).toFixed(t.market.price_decimals));stop_orders.filter(e=>e.market_id===t.id).forEach(i=>{let a=i.stop_price/Math.pow(10,t.market.price_decimals),o=i.amount.substring(i.amount.indexOf(" ")+1)===t.market.quote_symbol.substring(t.market.quote_symbol.indexOf(",")+1);if(o&&e>=a||!o&&e<=a){let s=[{account:String(session.auth.actor),name:"executeorder",authorization:[{actor:String(session.auth.actor),permission:"zeosexecstop"}],data:{id:i.id,aes_key:i.aes_key}}];window.transactJsSignatureProvider(chainId,nodeUrl,[stop_permission.key],s),console.log("executed order "+JSON.stringify(i)+" at price "+e),setTimeout(async()=>{await fetchMarket(mid),await fetchStopOrders(),updateUI(),fetchBalances()},3e3)}})}