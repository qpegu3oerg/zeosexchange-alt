const fetch=require("node-fetch"),express=require("express"),app=express(),PORT=9367;var bodyParser=require("body-parser");app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json()),app.use(express.static("static"));const apiNodes=["https://jungle4.cryptolions.io:443","http://jungle4.cryptolions.io:80","http://jungle.eosusa.news","http://15.204.22.80","https://jungle4.eosphere.io:443","http://89.38.98.37:8888","https://jungle4.genereos.io:443","http://jungle4.eossweden.org:80","https://jungle4.api.eosnation.io:443","https://api-jungle4.eosarabia.net:443"];var apiNodeIndex=0;const blocks=new Map;var symbols=[],timestamps=[],markets=[],ref_bn=0,ref_ts=0;function base_precision(e){return parseInt(e.market.base_symbol.substring(0,e.market.base_symbol.indexOf(",")))}function quote_precision(e){return parseInt(e.market.quote_symbol.substring(0,e.market.quote_symbol.indexOf(",")))}function base_symbolcode(e){return e.market.base_symbol.substring(e.market.base_symbol.indexOf(",")+1)}function quote_symbolcode(e){return e.market.quote_symbol.substring(e.market.quote_symbol.indexOf(",")+1)}async function setReferenceBlockTime(){try{let e=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_info",{method:"POST",mode:"cors",body:JSON.stringify({})}),t=await e.json();ref_bn=t.last_irreversible_block_num,ref_ts=new Date(t.last_irreversible_block_time+"+00:00").getTime()}catch(o){console.log(o.message)}apiNodeIndex=(apiNodeIndex+1)%apiNodes.length,console.log("updated reference block and time: "+ref_bn+", "+ref_ts)}async function fetchAllMarkets(){try{let e,t="",o=[];do{let a=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_table_rows",{method:"POST",mode:"cors",body:JSON.stringify({code:"zeosexchange",table:"markets",scope:"zeosexchange",lower_bound:t,json:!0})});e=await a.json(),o=[...o,...e.rows],t=e.next_key}while(e.more);markets=o;let s=Date.now();markets.forEach(e=>{timestamps[e.id]=s;let t=base_symbolcode(e)+"/"+quote_symbolcode(e);symbols[e.id]={description:t,exchange:"ZEOSEXCHANGE",full_name:"ZEOSEXCHANGE:"+t,symbol:t,type:"crypto",price_scale:Math.pow(10,e.market.price_decimals),volume_precision:base_precision(e)}})}catch(n){console.log(n.message)}apiNodeIndex=(apiNodeIndex+1)%apiNodes.length}async function fetchMarket(e){try{let t=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_table_rows",{method:"POST",mode:"cors",body:JSON.stringify({code:"zeosexchange",table:"markets",scope:"zeosexchange",lower_bound:e,upper_bound:e,limit:1,json:!0})}),o=(await t.json()).rows;if(0==o.length)return;timestamps[e]=Date.now(),markets[e]=o[0]}catch(a){console.log(a.message)}apiNodeIndex=(apiNodeIndex+1)%apiNodes.length}async function fetchBalance(e,t,o){try{let a=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_currency_balance",{method:"POST",mode:"cors",body:JSON.stringify({code:e,account:t,symbol:o,json:!0})});return await a.json()}catch(s){console.log(s.message)}apiNodeIndex=(apiNodeIndex+1)%apiNodes.length}async function fetchBlock(e){if(!blocks.has(e)){try{let t=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_block",{method:"POST",mode:"cors",body:JSON.stringify({block_num_or_id:e,json:!0})});blocks.set(e,await t.json())}catch(o){console.log(o.message)}apiNodeIndex=(apiNodeIndex+1)%apiNodes.length}}async function fetchAccount(e){let t="";try{let o=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_account",{method:"POST",mode:"cors",body:JSON.stringify({account_name:e,json:!0})});t=await o.json()}catch(a){console.log(a.message)}return apiNodeIndex=(apiNodeIndex+1)%apiNodes.length,t}async function fetchCodeHash(e){let t="";try{let o=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_code_hash",{method:"POST",mode:"cors",body:JSON.stringify({account_name:e,json:!0})});t=(await o.json()).code_hash}catch(a){console.log(a.message)}return apiNodeIndex=(apiNodeIndex+1)%apiNodes.length,t}async function fetchPermission(e){let t="";try{let o=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_table_rows",{method:"POST",mode:"cors",body:JSON.stringify({code:e,table:"permission",scope:e,json:!0})});res=await o.json(),1===res.rows.length&&(t=res.rows[0].key_ct)}catch(a){console.log(a.message)}return apiNodeIndex=(apiNodeIndex+1)%apiNodes.length,t}async function fetchStopOrders(e){let t,o="",a=[];try{do{let s=await fetch(apiNodes[apiNodeIndex]+"/v1/chain/get_table_rows",{method:"POST",mode:"cors",body:JSON.stringify({code:e,table:"orders",scope:e,lower_bound:o,json:!0})});t=await s.json(),a=[...a,...t.rows],o=t.next_key}while(t.more)}catch(n){console.log(n.message)}return apiNodeIndex=(apiNodeIndex+1)%apiNodes.length,a}function top_bar_values(e){let t=e.market.history[e.market.history.length-1].p/Math.pow(10,e.market.price_decimals),o=e.market.history[e.market.history.length-1].b,a=0,s=t,n=o-e.market.history[0].b<=172800?0:t,i=0;for(let c=e.market.history.length-1;c>=0;c--){if(e.market.history[c].b<=o-172800){a=e.market.history[c].p/Math.pow(10,e.market.price_decimals);break}s=Math.max(s,e.market.history[c].p/Math.pow(10,e.market.price_decimals)),n=Math.min(n,e.market.history[c].p/Math.pow(10,e.market.price_decimals)),i+=e.market.history[c].v/Math.pow(10,base_precision(e))}return{last_price:t,h24_change:(t/a-1)*100,h24_high:s,h24_low:n,h24_volume:i}}setReferenceBlockTime(),setInterval(setReferenceBlockTime,36e5),fetchAllMarkets(),app.post("/refblocktime",function(e,t){t.setHeader("content-type","application/json"),t.json({ref_bn,ref_ts})}),app.post("/symbols",function(e,t){t.setHeader("content-type","application/json"),t.json(symbols)}),app.post("/market",async function(e,t){e.body.hasOwnProperty("id")&&0<=e.body.id&&e.body.id<markets.length&&(timestamps[e.body.id]+5e3<Date.now()&&await fetchMarket(e.body.id),t.setHeader("content-type","application/json"),t.json(markets[e.body.id]))}),app.post("/balance",async function(e,t){t.setHeader("content-type","application/json"),t.json(await fetchBalance(e.body.code,e.body.account,e.body.symbol))}),app.post("/ticker",async function(e,t){let o=[];markets.forEach(e=>{let t=top_bar_values(e);o.push({symbol:base_symbolcode(e)+"/"+quote_symbolcode(e),last_price:t.last_price.toFixed(e.market.price_decimals),h24_change:(t.h24_change>0?"+":"")+t.h24_change.toFixed(2)+"%"})}),t.setHeader("content-type","application/json"),t.json(o)}),app.post("/history",async function(e,t){if(!(e.body.hasOwnProperty("id")&&0<=e.body.id&&e.body.id<markets.length)||!e.body.hasOwnProperty("num"))return;let o=parseInt(e.body.id),a=parseInt(e.body.num),s=!1,n=[];markets[o].history_blocks.forEach(e=>{e===a&&(s=!0)}),s&&(await fetchBlock(a),blocks.get(a).transactions.forEach(e=>{e.trx.transaction.actions.forEach(e=>{"zeosexchange"===e.account&&"archiveticks"===e.name&&parseInt(e.data.market_id)===o&&(n=e.data.history)})})),t.setHeader("content-type","application/json"),t.json(n)}),app.post("/account",async function(e,t){let o=await fetchAccount(e.body.account_name);t.setHeader("content-type","application/json"),t.json({account:o})}),app.post("/codehash",async function(e,t){let o=await fetchCodeHash(e.body.account_name);t.setHeader("content-type","application/json"),t.json({codehash:o})}),app.post("/permission",async function(e,t){let o=await fetchPermission(e.body.account_name);t.setHeader("content-type","application/json"),t.json({key_ct:o})}),app.post("/stoporders",async function(e,t){let o=await fetchStopOrders(e.body.account_name);t.setHeader("content-type","application/json"),t.json({orders:o})}),app.listen(9367,()=>console.log("Server listening on port: 9367"));
